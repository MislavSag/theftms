---
title: "Introduction to theft"
author: "Trent Henderson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to theft}
  %\VignetteEngine{knitr::knitr}
  %\usepackage[UTF-8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 6,
  fig.width = 9
)
```

```{r setup, message = FALSE, warning = FALSE}
library(dplyr)
library(theft)
library(tsibbledata)
```

## Core calculation functions

Before we look at the available functions in the package, let's first pull some time-series data.

```{r, message = FALSE, warning = FALSE}
d <- tsibbledata::aus_retail %>%
  rename(Series_ID = 3)
```

### Calculating feature summary statistics

The core function that automates the calculation of the feature statistics at once is `calculate_features`. You can choose which subset of features to calculate with the `feature_set` argument. The choices are currently `all`, `catch22`, `feasts`, `tsfeatures` or `tsfresh`.

Note that `tsfresh` and `tsfel` are Python packages. The R package `reticulate` is used to call Python code that uses `tsfresh` and applies it within the broader *tidy* data philosophy embodied by `theft`. At present, depending on the input time-series, `theft` provides access to ~1200 features. Prior to using `theft` (only if you want to use the `tsfresh` or `tsfel` feature sets - the R-based sets will run fine) you should have a working Python installation and download `tsfresh` using the instructions located [here](https://tsfresh.com) and `tsfel` [here](https://github.com/fraunhoferportugal/tsfel). For this reason, features included in these two sets are not included in the `all` argument option. 

Here is an example with the `catch22` set:

```{r, message = FALSE, warning = FALSE}
feature_matrix <- calculate_features(data = d, 
                                     id_var = "Series_ID", 
                                     time_var = "Month", 
                                     values_var = "Turnover", 
                                     group_var = "State",
                                     feature_set = "catch22")
```

If you do not want to or need to run the entire sets included in `calculate_features` you can also access the individual feature calculations as their unique function names, for example `IN_AutoMutualInfoStats_40_gaussian_fmmi`. A tidy dataframe of all the included feature calculations and the set they correspond to is available:

```{r, message = FALSE, warning = FALSE, eval = FALSE}
View(feature_list)
```

## Data quality checks

The package comes with a function to visualise the data types of the calculated feature vectors.

```{r, message = FALSE, warning = FALSE}
plot_quality_matrix(feature_matrix)
```

## Normalising/scaling functions

Putting calculated feature vectors on an equal scale is crucial for any statistical or machine learning model as variables with high variance can adversely impact the model's capacity to fit the data appropriately, learn appropriate weight values, or minimise a loss function. `theft` includes the functions `normalise_feature_vector` to rescale a vector of values (e.g. vector of values for all participants in a study on the `SB_BinaryStats_mean_longstretch1` feature), and `normalise_feature_frame` to rescale a vector within a dataframe into a variety of different ranges for ease-of-use. Current transformations available in the package include:

* z-score - `"z-score"`
* Sigmoid - `"Sigmoid"`
* Outlier-robust Sigmoid (credit to Ben Fulcher for creating the original [MATLAB version](https://github.com/benfulcher/hctsa)) - `"RobustSigmoid"`
* Min-max - `"MinMax"`
* Mean subtraction - `"MeanSubtract"`

Dataframe-based normalisation can be performed using the following:

```{r, message = FALSE, warning = FALSE}
normed <- normalise_feature_frame(feature_matrix, 
                                  names_var = "names", 
                                  values_var = "values", 
                                  method = "MinMax")
```

## Data visualisation functions

The package also comes with a built-in plotting engine for calculating and visualising (at present) three types of statistical graphics:

* Feature by time-series matrices as heatmaps
* Low dimension projections of the feature space for each time series as scatterplots
* Unique ID feature connectivity matrices as correlation-driven heatmaps

### Feature matrix

The function `plot_feature_matrix` takes the output of any included feature calculation function and produces a `ggplot` object heatmap showing the feature vectors across the `x` axis and each time series down the `y` axis. Prior to plotting, the function hierarchically clusters the data across both rows and columns to visually highlight the empirical structure.

```{r, message = FALSE, warning = FALSE}
plot_feature_matrix(feature_matrix, 
                    is_normalised = FALSE, 
                    id_var = "id", 
                    method = "MinMax")
```

### Dimension reduction

The function `plot_low_dimension` takes the output of any included feature calculation function, calculates a PCA or t-SNE, and produces a `ggplot` object scatterplot showing the first and second principal components on the `x` and `y` axis respectively, their individual explained variance, and each time series as a point on the `x-y` space. If `plot = FALSE` the function returns a dataframe of PCA results. If a variable is specified in the `group_var` argument, the scatterplot points will be automatically coloured by group.

```{r, message = FALSE, warning = FALSE}
plot_low_dimension(feature_matrix, 
                   is_normalised = FALSE, 
                   id_var = "id", 
                   group_var = "State", 
                   method = "MinMax", 
                   low_dim_method = "PCA", 
                   plot = TRUE)
```

Alternatively, a t-SNE version can be specified in a similar fashion, with the `perplexity` hyperparameter able to be controlled by the user. Typical values for this range between 5 and 50, depending on the size of the data.

```{r, message = FALSE, warning = FALSE}
plot_low_dimension(feature_matrix, 
                   is_normalised = FALSE, 
                   id_var = "id", 
                   group_var = "State", 
                   method = "MinMax", 
                   low_dim_method = "t-SNE", 
                   perplexity = 10, 
                   plot = TRUE)
```

### Connectivity matrix

The function `plot_connectivity_matrix` mimics the design of functional connectivity matrices commonly represented in neuroscience research. The function automates the calculation of correlations between feature vectors of each uniquely identified entity, the hierarchical clustering of rows and columns of these correlations, and the production of the final heatmap-style graphic.

```{r, message = FALSE, warning = FALSE, eval = FALSE}
plot_connectivity_matrix(normed, 
                         id_var = "id", 
                         names_var = "names", 
                         values_var = "values")
```
